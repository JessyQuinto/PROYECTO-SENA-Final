import{j as e}from"./radix-pxeQr2vL.js";import{b as x}from"./react-9ItUixmA.js";import{I as p,s as l}from"./index-DDd0kLwX.js";import{A as $}from"./AdminLayout-C4V03p12.js";import"./supabase-D999gSRu.js";import"./shadcn_misc-DPVfRoQl.js";const P=()=>{const[u,h]=x.useState([]),[_,v]=x.useState(!0),[j,S]=x.useState(""),k=x.useMemo(()=>{const a=j.trim().toLowerCase();return a?u.filter(s=>(s.email||"").toLowerCase().includes(a)||(s.nombre_completo||"").toLowerCase().includes(a)):u},[u,j]),C=async()=>{v(!0);const{data:a,error:s}=await l.from("users").select("id,email,role,vendedor_estado,bloqueado,nombre_completo,created_at").order("created_at",{ascending:!1});s&&console.error(s.message),h(a||[]),v(!1)};x.useEffect(()=>{C()},[]);const g=async(a,s)=>{const{error:i}=await l.from("users").update({vendedor_estado:s}).eq("id",a);if(i){window.toast?.error(i.message,{role:"admin",action:"approve"});return}h(r=>r.map(n=>n.id===a?{...n,vendedor_estado:s}:n)),window.toast?.success(`Vendedor ${s}`,{role:"admin",action:s==="aprobado"?"approve":"reject"});try{const n=(await l.auth.getSession()).data.session?.access_token,c="https://jdmexfawmetmfabpwlfs.supabase.co";if(!n||!c)return;const d=new URL(c).host.split(".")[0],m=u.find(y=>y.id===a),[{data:t},{data:o}]=await Promise.all([l.from("app_config").select("value").eq("key","notify_vendor_email_enabled").maybeSingle(),l.from("app_config").select("value").eq("key","notify_from").maybeSingle()]),f=t?.value?.enabled??!0,b=o?.value?.from;if(!f||!m?.email)return;const w=await fetch(`https://${d}.functions.supabase.co/notify-vendor-status`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({action:s,email:m.email,nombre:m.nombre_completo,from:b})});if(!w.ok){const y=await w.text().catch(()=>"");console.warn("[notify-vendor-status] respuesta no OK",w.status,y)}}catch(r){console.warn("[notify-vendor-status] warning",r)}},q=async(a,s)=>{try{const r=(await l.auth.getSession()).data.session?.access_token,n="https://jdmexfawmetmfabpwlfs.supabase.co";if(n&&r){const c=new URL(n).host.split(".")[0],d=await fetch(`https://${c}.functions.supabase.co/admin-users`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({action:"setRole",user_id:a,role:s})}),m=await d.json();if(!d.ok)throw new Error(m?.error||"No se pudo actualizar rol");h(t=>t.map(o=>o.id===a?{...o,role:s}:o)),window.toast?.success(`Rol actualizado a ${s}`,{role:"admin",action:"update"})}}catch(i){window.toast?.error(i?.message||"No se pudo actualizar rol",{role:"admin",action:"update"})}},N=async(a,s)=>{try{const r=(await l.auth.getSession()).data.session?.access_token,n="https://jdmexfawmetmfabpwlfs.supabase.co";if(n&&r){const c=new URL(n).host.split(".")[0],d=await fetch(`https://${c}.functions.supabase.co/admin-users`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({action:"suspend",user_id:a,blocked:s})}),m=await d.json();if(!d.ok)throw new Error(m?.error||"No se pudo suspender");h(t=>t.map(o=>o.id===a?{...o,bloqueado:s}:o)),window.toast?.success(s?"Usuario suspendido":"Usuario reactivado",{role:"admin",action:"update"});try{const t=u.find(o=>o.id===a);if(t?.email){const[{data:o},{data:f}]=await Promise.all([l.from("app_config").select("value").eq("key","notify_vendor_email_enabled").maybeSingle(),l.from("app_config").select("value").eq("key","notify_from").maybeSingle()]),b=o?.value?.enabled??!0,w=f?.value?.from;if(b){const y=s?"bloqueado":"reactivado";await fetch(`https://${c}.functions.supabase.co/notify-vendor-status`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({action:y,email:t.email,nombre:t.nombre_completo,from:w})}).catch(()=>{})}}}catch(t){console.warn("[notify-vendor-status] suspend warning",t)}}}catch(i){window.toast?.error(i?.message||"No se pudo suspender",{role:"admin",action:"update"})}},A=async a=>{if(confirm("¿Eliminar usuario? Esta acción es irreversible."))try{const i=(await l.auth.getSession()).data.session?.access_token,r="https://jdmexfawmetmfabpwlfs.supabase.co";if(r&&i){const n=new URL(r).host.split(".")[0],c=u.find(t=>t.id===a),d=await fetch(`https://${n}.functions.supabase.co/admin-users`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({action:"delete",user_id:a})}),m=await d.json();if(!d.ok)throw new Error(m?.error||"No se pudo eliminar");h(t=>t.filter(o=>o.id!==a)),window.toast?.success("Usuario eliminado",{role:"admin",action:"delete"});try{if(c?.email){const[{data:t},{data:o}]=await Promise.all([l.from("app_config").select("value").eq("key","notify_vendor_email_enabled").maybeSingle(),l.from("app_config").select("value").eq("key","notify_from").maybeSingle()]),f=t?.value?.enabled??!0,b=o?.value?.from;f&&await fetch(`https://${n}.functions.supabase.co/notify-vendor-status`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({action:"eliminado",email:c.email,nombre:c.nombre_completo,from:b})}).catch(()=>{})}}catch(t){console.warn("[notify-vendor-status] delete warning",t)}}}catch(s){window.toast?.error(s?.message||"No se pudo eliminar",{role:"admin",action:"delete"})}};return e.jsxs($,{title:"Usuarios",subtitle:"Gestiona roles, bloqueos y aprobación de vendedores",children:[e.jsx("div",{className:"mb-6 flex items-center justify-between",children:e.jsx("input",{className:"input-hero max-w-md",placeholder:"Buscar usuarios por correo o nombre...",value:j,onChange:a=>S(a.target.value)})}),e.jsx("div",{className:"card card-hover",children:e.jsx("div",{className:"card-body overflow-x-auto",children:_?e.jsx("p",{children:"Cargando..."}):e.jsxs("table",{className:"min-w-full text-sm table-auto",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-500 whitespace-nowrap",children:[e.jsx("th",{className:"py-2 pr-4 w-[32%]",children:"Email"}),e.jsx("th",{className:"py-2 pr-4 w-[20%]",children:"Nombre"}),e.jsx("th",{className:"py-2 pr-4 w-[14%]",children:"Rol"}),e.jsx("th",{className:"py-2 pr-4 w-[22%]",children:"Vendedor"}),e.jsx("th",{className:"py-2 pr-4 w-[6%]",children:"Bloqueado"}),e.jsx("th",{className:"py-2 w-[6%]",children:"Acciones"})]})}),e.jsx("tbody",{children:k.map(a=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"py-2 pr-4",children:e.jsx("div",{className:"max-w-[280px] truncate",title:a.email||"",children:a.email})}),e.jsx("td",{className:"py-2 pr-4",children:e.jsx("div",{className:"max-w-[200px] truncate",title:a.nombre_completo||"-",children:a.nombre_completo||"-"})}),e.jsx("td",{className:"py-2 pr-4",children:e.jsxs("select",{className:"form-select w-36",value:a.role||"comprador",onChange:s=>q(a.id,s.target.value),children:[e.jsx("option",{value:"comprador",children:"comprador"}),e.jsx("option",{value:"vendedor",children:"vendedor"}),e.jsx("option",{value:"admin",children:"admin"})]})}),e.jsx("td",{className:"py-2 pr-4",children:e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:`badge ${a.vendedor_estado==="aprobado"?"badge-success":a.vendedor_estado==="pendiente"?"badge-warning":"badge-secondary"} flex items-center gap-1`,title:a.vendedor_estado||"",children:[a.vendedor_estado==="aprobado"&&e.jsx(p,{category:"Administrador",name:"MdiShieldCheck",className:"w-3 h-3",alt:""}),a.vendedor_estado==="pendiente"&&e.jsx(p,{category:"Pedidos",name:"CarbonPendingFilled",className:"w-3 h-3",alt:""}),a.vendedor_estado==="rechazado"&&e.jsx(p,{category:"Estados y Feedback",name:"IconoirWarningSquare",className:"w-3 h-3",alt:""}),a.vendedor_estado||"-"]}),e.jsxs("button",{className:"btn btn-outline btn-sm flex items-center min-w-[100px] h-8",onClick:()=>g(a.id,"aprobado"),title:"Aprobar vendedor","aria-label":"Aprobar vendedor",children:[e.jsx(p,{category:"Administrador",name:"MdiShieldCheck",className:"w-4 h-4 md:mr-1",alt:""}),e.jsx("span",{className:"hidden md:inline",children:"Aprobar"})]}),e.jsxs("button",{className:"btn btn-outline btn-sm flex items-center min-w-[100px] h-8",onClick:()=>g(a.id,"rechazado"),title:"Rechazar vendedor","aria-label":"Rechazar vendedor",children:[e.jsx(p,{category:"Administrador",name:"FluentGavelProhibited16Filled",className:"w-4 h-4 md:mr-1",alt:""}),e.jsx("span",{className:"hidden md:inline",children:"Rechazar"})]})]})}),e.jsx("td",{className:"py-2 pr-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:`btn btn-outline btn-sm w-8 h-8 p-0 flex items-center justify-center ${a.bloqueado?"opacity-50 pointer-events-none":""}`,onClick:()=>N(a.id,!0),title:"Bloquear","aria-label":"Bloquear",children:e.jsx(p,{category:"Usuario",name:"MdiShieldOff",className:"w-4 h-4",alt:""})}),e.jsx("button",{className:`btn btn-outline btn-sm w-8 h-8 p-0 flex items-center justify-center ${a.bloqueado?"":"opacity-50 pointer-events-none"}`,onClick:()=>N(a.id,!1),title:"Desbloquear","aria-label":"Desbloquear",children:e.jsx(p,{category:"Administrador",name:"FluentGavel32Filled",className:"w-4 h-4",alt:""})})]})}),e.jsx("td",{className:"py-2",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{className:"btn btn-outline btn-sm flex items-center min-w-[100px] h-8",onClick:()=>alert("Historial y métricas del usuario próximamente"),title:"Detalles","aria-label":"Detalles",children:[e.jsx(p,{category:"Administrador",name:"LucideFileClock",className:"w-4 h-4 md:mr-1",alt:""}),e.jsx("span",{className:"hidden md:inline",children:"Detalles"})]}),e.jsxs("button",{className:"btn btn-danger btn-sm flex items-center min-w-[100px] h-8",onClick:()=>A(a.id),title:"Eliminar","aria-label":"Eliminar",children:[e.jsx(p,{category:"Vendedor",name:"LineMdTrash",className:"w-4 h-4 md:mr-1",alt:""}),e.jsx("span",{className:"hidden md:inline",children:"Eliminar"})]})]})})]},a.id))})]})})})]})};export{P as default};
