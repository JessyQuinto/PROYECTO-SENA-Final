import{j as e}from"./radix-pxeQr2vL.js";import{b as c}from"./react-9ItUixmA.js";import{d as ce,s as g,I as p,C as L,b as z,B as ne}from"./index-DDd0kLwX.js";import{I as n}from"./input-s_SeVYy5.js";import{C as w}from"./checkbox-Yuj4HFAq.js";import"./supabase-D999gSRu.js";import"./shadcn_misc-DPVfRoQl.js";const ge=()=>{const{items:S,total:A,clear:W}=ce(),[s,u]=c.useState({nombre:"",telefono:"",direccion:"",direccion2:"",ciudad:"",departamento:"",codigoPostal:""}),[k,G]=c.useState(!0),[o,x]=c.useState({nombre:"",direccion:"",ciudad:"",departamento:"",codigoPostal:""}),[l,P]=c.useState("tarjeta"),[i,y]=c.useState({titular:"",numero:"",vencimiento:"",cvc:""}),[B,H]=c.useState(!1),[R,E]=c.useState(!1),[f,O]=c.useState([]),[$,U]=c.useState([]),[Y,M]=c.useState(""),[J,K]=c.useState(""),[Q,D]=c.useState(""),[V,X]=c.useState(!1),[q,Z]=c.useState(!1),[F,ee]=c.useState(!1);c.useMemo(()=>window.supabaseSessionEmail,[]),c.useEffect(()=>{(async()=>{try{if(!g)return;const t=(await g.auth.getSession()).data.session?.user?.id;if(!t)return;const r=await g.from("user_address").select("*").eq("user_id",t).order("es_predeterminada",{ascending:!1}).order("created_at",{ascending:!1}),I=await g.from("user_payment_profile").select("*").eq("user_id",t).order("es_predeterminada",{ascending:!1}).order("created_at",{ascending:!1}),j=r.data||[],b=I.data||[];O(j),U(b);const d=j.find(h=>h.tipo==="envio"&&h.es_predeterminada)||j.find(h=>h.tipo==="envio");d&&(M(d.id),u({nombre:d.nombre,telefono:d.telefono||"",direccion:d.direccion,direccion2:d.direccion2||"",ciudad:d.ciudad,departamento:d.departamento,codigoPostal:d.codigo_postal||""}));const v=b.find(h=>h.es_predeterminada)||b[0];v&&(D(v.id),P(v.metodo))}catch(a){console.warn("[checkout] load profiles error",a)}})()},[]);const ae=async()=>{if(S.length===0){window.toast?.error("Carrito vacío",{role:"comprador",action:"purchase"});return}if(!s.nombre||!s.telefono||!s.direccion||!s.ciudad||!s.departamento||!s.codigoPostal){window.toast?.error("Completa datos de envío (nombre, teléfono, dirección, ciudad, departamento, código postal)",{role:"comprador",action:"purchase"});return}if(!k&&(!o.nombre||!o.direccion||!o.ciudad||!o.departamento||!o.codigoPostal)){window.toast?.error("Completa datos de facturación",{role:"comprador",action:"purchase"});return}if(l==="tarjeta"){const a=i.numero.replace(/\s+/g,""),t=i.vencimiento.trim(),r=i.cvc.trim();if(!i.titular||a.length<13||a.length>19||!/^(0[1-9]|1[0-2])\/(\d{2})$/.test(t)||!(r.length===3||r.length===4)){window.toast?.error("Revisa los datos de la tarjeta (titular, número, vencimiento MM/YY, CVC)",{role:"comprador",action:"purchase"});return}}if(!B){window.toast?.error("Debes aceptar términos y política de privacidad",{role:"comprador",action:"purchase"});return}E(!0);try{const a=(await g.auth.getSession()).data.session,t=a?.user?.id;if(!t)throw new Error("Sesión no disponible");const r=[];if(V&&r.push(g.from("user_address").insert({user_id:t,tipo:"envio",nombre:s.nombre,telefono:s.telefono,direccion:s.direccion,direccion2:s.direccion2||null,ciudad:s.ciudad,departamento:s.departamento,codigo_postal:s.codigoPostal,es_predeterminada:f.filter(m=>m.tipo==="envio").length===0})),q&&!k&&r.push(g.from("user_address").insert({user_id:t,tipo:"facturacion",nombre:o.nombre,telefono:null,direccion:o.direccion,direccion2:null,ciudad:o.ciudad,departamento:o.departamento,codigo_postal:o.codigoPostal,es_predeterminada:f.filter(m=>m.tipo==="facturacion").length===0})),F){const m=i.numero.replace(/\s+/g,""),N=l==="tarjeta"&&m.length>=4?m.slice(-4):null,C=i.vencimiento.split("/")||[],_=Number(C[0])||null,T=Number(C[1])||null,re=l==="tarjeta"?`Tarjeta •••• ${N||""}`:"Contraentrega";r.push(g.from("user_payment_profile").insert({user_id:t,metodo:l,etiqueta:re,titular:l==="tarjeta"?i.titular:null,last4:N,exp_mm:l==="tarjeta"?_:null,exp_yy:l==="tarjeta"?T:null,es_predeterminada:$.length===0}))}r.length&&await Promise.allSettled(r);const I=S.map(m=>({producto_id:m.productoId,cantidad:m.cantidad})),j="http://localhost:4000",b=a?.access_token,d=await fetch(`${j.replace(/\/$/,"")}/rpc/crear_pedido`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b}`},body:JSON.stringify({items:I,shipping:{nombre:s.nombre,direccion:[s.direccion,s.direccion2].filter(Boolean).join(", "),ciudad:`${s.ciudad} (${s.departamento}) ${s.codigoPostal}`,telefono:s.telefono},simulate_payment:l==="tarjeta"})}),v=await d.json();if(!d.ok)throw new Error(v?.error||"Error creando pedido");const h=v.order_id;try{const m=(await g.auth.getSession()).data.session,N=m?.access_token,C="https://jdmexfawmetmfabpwlfs.supabase.co",_=m?.user?.email;if(C&&N&&_){const T=new URL(C).host.split(".")[0];await fetch(`https://${T}.functions.supabase.co/order-emails`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${N}`},body:JSON.stringify({action:"receipt",email:_,order_id:h})})}}catch{}W(),window.toast?.success("Compra realizada",{role:"comprador",action:"purchase"}),window.location.href=`/recibo/${h}`}catch(a){window.toast?.error(a?.message||"Error en el checkout",{role:"comprador",action:"purchase"})}finally{E(!1)}},se=a=>{M(a);const t=f.find(r=>r.id===a);t&&u({nombre:t.nombre,telefono:t.telefono||"",direccion:t.direccion,direccion2:t.direccion2||"",ciudad:t.ciudad,departamento:t.departamento,codigoPostal:t.codigo_postal||""})},te=a=>{K(a);const t=f.find(r=>r.id===a);t&&x({nombre:t.nombre,direccion:t.direccion,ciudad:t.ciudad,departamento:t.departamento,codigoPostal:t.codigo_postal||""})},oe=a=>{D(a);const t=$.find(r=>r.id===a);t&&(P(t.metodo),t.metodo==="tarjeta"&&y(r=>({...r,titular:t.titular||""})))};return e.jsxs("div",{className:"container py-8",children:[e.jsxs("h1",{className:"heading-lg mb-6 flex items-center gap-3",children:[e.jsx(p,{category:"Carrito y checkout",name:"StreamlinePlumpPaymentRecieve7Solid",className:"w-8 h-8"}),"Checkout"]}),e.jsx("div",{className:"rounded-xl h-10 mb-6 overflow-hidden",style:{backgroundImage:"linear-gradient(to right, rgba(0,0,0,0.08), rgba(0,0,0,0.02)), url('/assert/motif-de-fond-sans-couture-tribal-dessin-geometrique-noir-et-blanc-vecteur/v1045-03.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}),S.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(p,{category:"Carrito y checkout",name:"WhhShoppingcart",className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{children:"Tu carrito está vacío"})]}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx(L,{className:"lg:col-span-2",children:e.jsxs(z,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h2",{className:"font-semibold flex items-center gap-2",children:[e.jsx(p,{category:"Carrito y checkout",name:"Fa6SolidTruck",className:"w-5 h-5"}),"Datos de envío"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 items-end",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"form-label mb-1 text-sm",children:"Perfiles guardados"}),e.jsxs("select",{className:"input w-full",value:Y,onChange:a=>se(a.target.value),children:[e.jsx("option",{value:"",children:"Selecciona un perfil (opcional)"}),f.filter(a=>a.tipo==="envio").map(a=>e.jsxs("option",{value:a.id,children:[a.nombre," — ",a.ciudad,", ",a.departamento]},a.id))]})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx(w,{checked:V,onCheckedChange:a=>X(!!a)}),"Guardar como perfil de envío"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(n,{placeholder:"Nombre completo",value:s.nombre,onChange:a=>u({...s,nombre:a.target.value})}),e.jsx(n,{placeholder:"Teléfono",value:s.telefono,onChange:a=>u({...s,telefono:a.target.value})}),e.jsx(n,{className:"md:col-span-2",placeholder:"Dirección",value:s.direccion,onChange:a=>u({...s,direccion:a.target.value})}),e.jsx(n,{className:"md:col-span-2",placeholder:"Apto, interior, referencia (opcional)",value:s.direccion2,onChange:a=>u({...s,direccion2:a.target.value})}),e.jsx(n,{placeholder:"Ciudad",value:s.ciudad,onChange:a=>u({...s,ciudad:a.target.value})}),e.jsx(n,{placeholder:"Departamento",value:s.departamento,onChange:a=>u({...s,departamento:a.target.value})}),e.jsx(n,{placeholder:"Código postal",value:s.codigoPostal,onChange:a=>u({...s,codigoPostal:a.target.value})})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h2",{className:"font-semibold flex items-center gap-2",children:[e.jsx(p,{category:"Carrito y checkout",name:"HugeiconsMapsLocation01",className:"w-5 h-5"}),"Datos de facturación"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx(w,{checked:k,onCheckedChange:a=>G(!!a)}),e.jsx("span",{children:"Usar los mismos datos de envío"})]}),!k&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 items-end",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"form-label mb-1 text-sm",children:"Perfiles guardados"}),e.jsxs("select",{className:"input w-full",value:J,onChange:a=>te(a.target.value),children:[e.jsx("option",{value:"",children:"Selecciona un perfil (opcional)"}),f.filter(a=>a.tipo==="facturacion").map(a=>e.jsxs("option",{value:a.id,children:[a.nombre," — ",a.ciudad,", ",a.departamento]},a.id))]})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx(w,{checked:q,onCheckedChange:a=>Z(!!a)}),"Guardar como perfil de facturación"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(n,{placeholder:"Nombre completo",value:o.nombre,onChange:a=>x({...o,nombre:a.target.value})}),e.jsx(n,{className:"md:col-span-2",placeholder:"Dirección",value:o.direccion,onChange:a=>x({...o,direccion:a.target.value})}),e.jsx(n,{placeholder:"Ciudad",value:o.ciudad,onChange:a=>x({...o,ciudad:a.target.value})}),e.jsx(n,{placeholder:"Departamento",value:o.departamento,onChange:a=>x({...o,departamento:a.target.value})}),e.jsx(n,{placeholder:"Código postal",value:o.codigoPostal,onChange:a=>x({...o,codigoPostal:a.target.value})})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h2",{className:"font-semibold flex items-center gap-2",children:[e.jsx(p,{category:"Carrito y checkout",name:"VaadinWallet",className:"w-5 h-5"}),"Método de pago"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 items-end",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"form-label mb-1 text-sm",children:"Perfiles guardados"}),e.jsxs("select",{className:"input w-full",value:Q,onChange:a=>oe(a.target.value),children:[e.jsx("option",{value:"",children:"Selecciona un perfil (opcional)"}),$.map(a=>e.jsx("option",{value:a.id,children:a.etiqueta},a.id))]})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx(w,{checked:F,onCheckedChange:a=>ee(!!a)}),"Guardar como perfil de pago"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("label",{className:`select-card p-4 ${l==="tarjeta"?"selected":""}`,children:[e.jsx("input",{type:"radio",name:"pay",className:"sr-only",checked:l==="tarjeta",onChange:()=>P("tarjeta")}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-gray-100 rounded",children:e.jsx(p,{category:"Carrito y checkout",name:"VaadinWallet",className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Tarjeta (simulado)"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Validaremos formato y simularemos aprobación"})]})]})]}),e.jsxs("label",{className:`select-card p-4 ${l==="contraentrega"?"selected":""}`,children:[e.jsx("input",{type:"radio",name:"pay",className:"sr-only",checked:l==="contraentrega",onChange:()=>P("contraentrega")}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-gray-100 rounded",children:e.jsx(p,{category:"Carrito y checkout",name:"Fa6SolidTruck",className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Contraentrega"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Paga al recibir (simulado)"})]})]})]})]}),l==="tarjeta"&&e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(n,{className:"md:col-span-2",placeholder:"Titular de la tarjeta",value:i.titular,onChange:a=>y({...i,titular:a.target.value})}),e.jsx(n,{placeholder:"Número de tarjeta",value:i.numero,onChange:a=>y({...i,numero:a.target.value})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(n,{placeholder:"Vencimiento (MM/YY)",value:i.vencimiento,onChange:a=>y({...i,vencimiento:a.target.value})}),e.jsx(n,{placeholder:"CVC",value:i.cvc,onChange:a=>y({...i,cvc:a.target.value})})]})]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx(w,{checked:B,onCheckedChange:a=>H(!!a)}),e.jsx("span",{children:"He leído y acepto los Términos y la Política de Privacidad"})]})]})}),e.jsx(L,{children:e.jsxs(z,{className:"p-6 space-y-3",children:[e.jsxs("h2",{className:"font-semibold flex items-center gap-2",children:[e.jsx(p,{category:"Carrito y checkout",name:"WhhShoppingcart",className:"w-5 h-5"}),"Resumen"]}),e.jsx("div",{className:"rounded-lg p-3",style:{backgroundImage:"linear-gradient(to right, rgba(0,0,0,0.04), rgba(0,0,0,0.00)), url('/assert/afrique-doodle-set/7311.jpg')",backgroundSize:"cover",backgroundPosition:"center"},children:e.jsx("p",{className:"text-sm opacity-80",children:"Gracias por confiar en nuestros artesanos. Revisa tu resumen antes de pagar."})}),e.jsx("ul",{className:"text-sm space-y-1 max-h-48 overflow-auto",children:S.map(a=>e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"truncate",children:[a.nombre," x",a.cantidad]}),e.jsxs("span",{children:["$",(a.precio*a.cantidad).toLocaleString()]})]},a.productoId))}),e.jsxs("div",{className:"text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(p,{category:"Carrito y checkout",name:"HugeiconsMapsLocation01",className:"w-3 h-3"}),"Envío a: ",s.direccion,s.direccion2?`, ${s.direccion2}`:""]}),e.jsxs("div",{children:[s.ciudad,s.departamento?`, ${s.departamento}`:""," ",s.codigoPostal]}),e.jsxs("div",{children:["Contacto: ",s.telefono]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-gray-600 flex items-center gap-2",children:[e.jsx(p,{category:"Carrito y checkout",name:"VaadinWallet",className:"w-4 h-4"}),"Total"]}),e.jsxs("span",{className:"text-2xl font-bold text-(--color-terracotta-suave)",children:["$",A.toLocaleString()]})]}),e.jsx(ne,{className:"w-full flex items-center justify-center gap-2",disabled:R,onClick:ae,children:R?e.jsxs(e.Fragment,{children:[e.jsx(p,{category:"Estados y Feedback",name:"HugeiconsReload",className:"w-4 h-4 animate-spin"}),"Procesando…"]}):e.jsxs(e.Fragment,{children:[e.jsx(p,{category:"Carrito y checkout",name:"StreamlinePlumpPaymentRecieve7Solid",className:"w-4 h-4"}),"Pagar ahora"]})})]})})]})]})};export{ge as default};
