{"collection":{"info":{"_postman_id":"eb4660c1-7955-4ac2-8b41-d9f99484d0e5","name":"Tesoros Chocó API - Flujo Administrador","description":"# API Tesoros Chocó - Documentación Completa\n\n## 🏗️ Arquitectura\n```\nReact Frontend ↔ Express Backend ↔ Supabase (PostgreSQL + Auth)\n```\n\n## 🔑 Variables Principales\n- `backend_base_url`: http://localhost:4000\n- `supabase_rest_url`: https://jdmexfawmetmfabpwlfs.supabase.co\n- `admin_email`: admin@tesoros-choco.com\n- `admin_password`: admin123\n- `demo_producto_id`: 228eddbe-8f20-43f4-a8aa-bb699a9f7b9b\n\n## ⚡ Orden de Ejecución\n1. Health Check\n2. Dev Seed (opcional)\n3. Auth Supabase\n4. Crear Usuario\n5. Asignar Rol\n6. Aprobar Vendedor\n\n## ⚠️ Prerequisitos\n- Backend ejecutándose en puerto 4000\n- NODE_ENV=development en Backend/.env\n- DEV_SEED_SECRET=CHANGEME_DEV_SECRET\n- Clave de Supabase actualizada en el environment\n\n## 📝 Notas Importantes\n- Esta colección requiere permisos de administrador\n- El Dev Seed solo funciona si el backend se reinicia con las variables correctas\n- Las variables dinámicas se establecen automáticamente durante la ejecución\n- ⚠️ **Importante**: Esta colección usa variables del environment. Asegúrate de tener configurado el environment correspondiente con los valores correctos.\n- ⚠️ **Importante**: Para usar las funciones de administrador, debes tener un usuario con rol de administrador.\n- ⚠️ **Importante**: La solicitud Dev Seed solo funciona en ambiente de desarrollo con la variable DEV_SEED_SECRET configurada correctamente.\n\n## 📋 Variables de Colección\n- `auth_token`: Token JWT de autenticación de administrador (se establece automáticamente)\n- `user_id`: ID del usuario administrador (se establece automáticamente)\n- `admin_user_id`: ID del usuario administrador creado por Dev Seed (se establece automáticamente)\n- `new_user_id`: ID del nuevo usuario creado (se establece automáticamente)\n- `order_id`: ID del pedido (se establece automáticamente si se usa)\n\n## 🛠️ Solución de Problemas\n- Si recibes errores 403 en las solicitudes de administrador, verifica que el usuario tenga rol de administrador\n- Si recibes errores 403 en el Dev Seed, asegúrate de que el backend esté configurado correctamente con NODE_ENV=development y DEV_SEED_SECRET\n- Si recibes errores 401, verifica que las credenciales de administrador sean correctas","schema":"https://schema.getpostman.com/json/collection/v2.1.0/collection.json","updatedAt":"2025-09-07T22:28:13.000Z","createdAt":"2025-09-02T22:39:40.000Z","lastUpdatedBy":"13226867","uid":"13226867-eb4660c1-7955-4ac2-8b41-d9f99484d0e5"},"item":[{"name":"🔍 Health Check","item":[{"name":"GET /health","event":[{"listen":"test","script":{"exec":["pm.test('Status 200', () => pm.response.code === 200);","pm.test('Service OK', () => {","  const j = pm.response.json();","  pm.expect(j.ok).to.be.true;","  pm.expect(j.service).to.equal('backend-demo');","});","console.log('✅ Backend health check passed');"],"type":"text/javascript"}}],"id":"c9499e14-8e71-4b26-b302-1ce8d6b31841","request":{"method":"GET","header":[],"url":{"raw":"{{backend_base_url}}/health","host":["{{backend_base_url}}"],"path":["health"]}},"response":[],"uid":"13226867-c9499e14-8e71-4b26-b302-1ce8d6b31841"}],"id":"03d58a30-d717-495f-b8c1-f32f478f17d9","description":"Verificar estado del backend Express","uid":"13226867-03d58a30-d717-495f-b8c1-f32f478f17d9"},{"name":"🌱 Dev Seed","item":[{"name":"POST /dev/ensure-admin","event":[{"listen":"test","script":{"exec":["if (pm.response.code === 403) {","  pm.test('Forbidden - Backend needs restart', () => pm.response.code === 403);","  console.log('❌ DEV_SEED_SECRET not loaded - restart backend');","  return;","}","if (pm.response.code === 200) {","  const j = pm.response.json();","  pm.test('Admin created', () => j.ok === true);","  if (j.user_id) pm.collectionVariables.set('admin_user_id', j.user_id);","  console.log('✅ Admin user ensured');","} else {","  console.log('❌ Error:', pm.response.text());","}"],"type":"text/javascript"}}],"id":"761d6b37-3393-4156-852b-a2b74d2c2449","request":{"method":"POST","header":[{"key":"Content-Type","value":"application/json"},{"key":"X-Dev-Secret","value":"{{dev_seed_secret}}"}],"body":{"mode":"raw","raw":"{\"email\":\"{{admin_email}}\",\"password\":\"{{admin_password}}\"}"},"url":{"raw":"{{backend_base_url}}/dev/ensure-admin","host":["{{backend_base_url}}"],"path":["dev","ensure-admin"]}},"response":[],"uid":"13226867-761d6b37-3393-4156-852b-a2b74d2c2449"}],"id":"a478ce58-8190-4b87-a7eb-a78f66858d03","description":"Crear usuario admin para desarrollo","uid":"13226867-a478ce58-8190-4b87-a7eb-a78f66858d03"},{"name":"🔐 Auth","item":[{"name":"POST Supabase Auth","event":[{"listen":"test","script":{"exec":["if (pm.response.code === 200) {","  const j = pm.response.json();","  pm.test('Auth successful', () => !!j.access_token);","  pm.collectionVariables.set('auth_token', j.access_token || '');","  pm.collectionVariables.set('user_id', j.user?.id || '');","  console.log('✅ Authenticated with Supabase');","} else {","  pm.test('Auth failed', () => false);","  console.log('❌ Auth error:', pm.response.text());","}"],"type":"text/javascript"}}],"id":"26f5dc67-095b-4d36-852f-5e170f164a10","request":{"method":"POST","header":[{"key":"Content-Type","value":"application/json"},{"key":"apikey","value":"{{supabase_anon_key}}"}],"body":{"mode":"raw","raw":"{\"email\":\"{{admin_email}}\",\"password\":\"{{admin_password}}\"}"},"url":{"raw":"{{supabase_rest_url}}/auth/v1/token?grant_type=password","host":["{{supabase_rest_url}}"],"path":["auth","v1","token"],"query":[{"key":"grant_type","value":"password"}]}},"response":[],"uid":"13226867-26f5dc67-095b-4d36-852f-5e170f164a10"},{"name":"POST Backend Post-Signup","event":[{"listen":"test","script":{"exec":["if (!pm.collectionVariables.get('user_id')) {","  pm.test('Skip - no user_id', () => true);","  return;","}","pm.test('Status 200', () => pm.response.code === 200);","console.log('✅ User profile synced');"],"type":"text/javascript"}}],"id":"3eeb402d-7f81-42e8-abd2-62f5368d8061","request":{"method":"POST","header":[{"key":"Content-Type","value":"application/json"}],"body":{"mode":"raw","raw":"{\"user_id\":\"{{user_id}}\",\"email\":\"{{admin_email}}\",\"role\":\"admin\"}"},"url":{"raw":"{{backend_base_url}}/auth/post-signup","host":["{{backend_base_url}}"],"path":["auth","post-signup"]}},"response":[],"uid":"13226867-3eeb402d-7f81-42e8-abd2-62f5368d8061"}],"id":"39d81edc-0ff6-4c60-8405-e31409e02bf3","description":"Autenticación directa con Supabase (simula frontend)","uid":"13226867-39d81edc-0ff6-4c60-8405-e31409e02bf3"},{"name":"👥 Gestión de Usuarios","item":[{"name":"POST /admin/create-user - Crear Usuario","event":[{"listen":"test","script":{"exec":["if (!pm.collectionVariables.get('auth_token')) {","  pm.test('Skip - no auth token', () => true);","  return;","}","if (pm.response.code === 200) {","  const j = pm.response.json();","  pm.collectionVariables.set('new_user_id', j.user_id || '');","  pm.test('User created', () => !!j.user_id);","  console.log('✅ User created:', j.user_id);","} else {","  pm.test('User creation failed', () => false);","  console.log('❌ User creation error:', pm.response.text());","}"],"type":"text/javascript"}}],"id":"13226867-13226867-13226867-new-request-1","request":{"method":"POST","header":[{"key":"Content-Type","value":"application/json"},{"key":"Authorization","value":"Bearer {{auth_token}}"}],"body":{"mode":"raw","raw":"{\"email\":\"test-vendedor@example.com\",\"password\":\"test123456\",\"role\":\"vendedor\",\"nombre\":\"Vendedor de Prueba\"}"},"url":{"raw":"{{backend_base_url}}/admin/create-user","host":["{{backend_base_url}}"],"path":["admin","create-user"]}},"response":[]},{"name":"POST /admin/users/:id/role - Asignar Rol","event":[{"listen":"test","script":{"exec":["if (!pm.collectionVariables.get('auth_token')) {","  pm.test('Skip - no auth token', () => true);","  return;","}","if (!pm.collectionVariables.get('new_user_id')) {","  pm.test('Skip - no user id', () => true);","  return;","}","pm.test('Status 200', () => pm.response.code === 200);","console.log('✅ User role updated');"],"type":"text/javascript"}}],"id":"fe6c79b8-eb7d-4e83-9998-5359b659b98b","request":{"method":"POST","header":[{"key":"Content-Type","value":"application/json"},{"key":"Authorization","value":"Bearer {{auth_token}}"}],"body":{"mode":"raw","raw":"{\"role\":\"vendedor\"}"},"url":{"raw":"{{backend_base_url}}/admin/users/{{new_user_id}}/role","host":["{{backend_base_url}}"],"path":["admin","users","{{new_user_id}}","role"]}},"response":[],"uid":"13226867-fe6c79b8-eb7d-4e83-9998-5359b659b98b"}],"id":"13226867-13226867-13226867-user-management-folder","description":"Gestión de usuarios administrativos"},{"name":"✅ Aprobar Vendedor","item":[{"name":"PUT /users/:id - Aprobar Vendedor","event":[{"listen":"test","script":{"exec":["if (!pm.collectionVariables.get('auth_token')) {","  pm.test('Skip - no auth token', () => true);","  return;","}","if (!pm.collectionVariables.get('new_user_id')) {","  pm.test('Skip - no user id', () => true);","  return;","}","pm.test('Status 200', () => pm.response.code === 200);","console.log('✅ Vendor approved');"],"type":"text/javascript"}}],"id":"13226867-13226867-13226867-approve-vendor-request","request":{"method":"PUT","header":[{"key":"Content-Type","value":"application/json"},{"key":"Authorization","value":"Bearer {{auth_token}}"}],"body":{"mode":"raw","raw":"{\"vendedor_estado\":\"aprobado\"}"},"url":{"raw":"{{backend_base_url}}/users/{{new_user_id}}","host":["{{backend_base_url}}"],"path":["users","{{new_user_id}}"]}},"response":[]}],"id":"13226867-13226867-13226867-approve-vendor-folder","description":"Aprobar vendedor creado"}],"variable":[{"key":"backend_base_url","value":"http://localhost:4000"},{"key":"supabase_rest_url","value":"https://jdmexfawmetmfabpwlfs.supabase.co"},{"key":"supabase_anon_key","value":"{{supabase_anon_key}}"},{"key":"admin_email","value":"admin@tesoros-choco.com"},{"key":"admin_password","value":"admin123"},{"key":"demo_producto_id","value":"228eddbe-8f20-43f4-a8aa-bb699a9f7b9b"},{"key":"dev_seed_secret","value":"CHANGEME_DEV_SECRET"},{"key":"auth_token","value":""},{"key":"user_id","value":""},{"key":"admin_user_id","value":""},{"key":"order_id","value":""},{"key":"new_user_id","value":""},{"key":"supabase_functions_base_url","value":""},{"key":"buyer_email","value":""},{"key":"buyer_password","value":""},{"key":"admin_auth_token","value":""},{"key":"buyer_user_id","value":""},{"key":"order_item_id","value":""},{"key":"timestamp","value":""},{"key":"_last_update_note","value":"Colección corregida - Variable supabase_anon_key actualizada con el valor real del API key"}]}}
